<header>
  <h4 id="Star-Info"></h4>
</header>

<script>

var histOutputBinding = new Shiny.OutputBinding();

  $.extend(histOutputBinding, {
    find: function(scope) {
      return $(scope).find('.shiny-Star');
    },
    renderValue: function(el, data) {
    //remove the old graph
	document.getElementById("theStar").innerHTML = "";
	if(data == null ) {return;}
	
	var nbRows=data.gridInfo.nbLines;
	var nbColumns=data.gridInfo.nbColumns;
	var topology = data.gridInfo.topology;
	var superclass = data.superclass;
	var superclassColor = data.superclassColor;
    var cellSize = data.sizeInfo;
	var nbSommet = data.nbSommet;
	var label = data.label;
	var starPlotNormalizedValues = data.starPlotNormalizedValues;
	var starPlotRealValues = data.starPlotRealValues;
    var w = cellSize*nbColumns;
    var h = cellSize*nbRows;
	document.getElementById("Star-Info").style.textAlign = "center";
	
	if(topology.localeCompare('rectangular')==0){
		d3.select('#Star-Info').text(function () {return 'Square Grid : Etoile';});
		starPlotSquareGrid();
	}else if(topology.localeCompare('hexagonal')==0){
		d3.select('#Star-Info').text(function () {return 'Hexagonal Grid : Etoile';});
		starPlotHexagonalGrid();
	}
	
	function starPlotSquareGrid(){
		
		var svg = d3.select('#theStar').append('svg')
			.attr("style"," display:block; margin:auto; margin-top:30px; background-color:blue")
			.attr({
				width: w,
				height: h
			});
					
		_.times(nbRows, function(n) {
			var rows = svg.selectAll('rect' + ' .row-' + (n + 1))
				.data(d3.range(nbColumns))
				.enter().append('rect')
				.attr({
					class: function(d, i) {
						return 'square row-' + (n + 1) + ' ' + 'col-' + (i + 1);
					},
					id: function(d, i) {
						return 's-' + (n + 1) + (i + 1);
					},
					width: cellSize,
					height: cellSize,
					x: function(d, i) {
						return i * cellSize;
					},
					y: n * cellSize,
					fill: function(d, i) {
						var indice = superclass[(n*nbColumns)+i];
						return superclassColor[indice-1];
					},
					stroke: '#FDBB30'
				});

			var array = d3.range(nbColumns);
			
			svg.selectAll('rect' + ' .row-' + (n + 1))
				.data(d3.range(nbColumns))
				.append('g')
							  
			for (p = 0; p < array.length; p++) {   
				
				var innerArrayNormalizedValues= starPlotNormalizedValues[(n*nbColumns)+p];	
				var innerArrayRealValues= starPlotRealValues[(n*nbColumns)+p];	
				
				var arrayValues = new Array(1);
				arrayValues[0] = new Array(nbSommet);
				for(var j=0; j<nbSommet; j++){
					arrayValues[0][j] = {axis: label[j], value: innerArrayNormalizedValues[j], realValue: innerArrayRealValues[j]};
				}
				
				// Dimension of the graph
				var w = cellSize*80/100,
					h = cellSize*80/100;
					
				//Options for the Radar chart, other than default
				var mycfg = {
					w: w,
					h: h,
					levels: 6,
					ExtraWidthX: cellSize,
					radius: cellSize*5/100,
					x: (p * cellSize)+cellSize*10/100,
					y: (n * cellSize)+cellSize*10/100.
				}

				//Call function to draw the Radar chart
				//Will expect that data is in %'s
				RadarChart.draw("#theStar", arrayValues, mycfg);
				
				rows.on('mouseover', function (d, i) {
				var el = d3.select(this)
					.transition()
					.duration(10)		  
					.style("fill-opacity", 0.8);
								
				d3.select('#Star-Info').text(function () {
					var ch = 'row: ' + (n + 1) + ' | ' + 'column: ' + (i + 1) + ' | ' + 'superclasse : ' + superclass[(n*nbColumns)+i];
					return ch;
					}); 
				});

				rows.on('mouseout', function (d, i) {
					var el = d3.select(this)
						.transition()
						.duration(1000)
						.style("fill-opacity", 1);
				});
			}
		});
	}
	
	function starPlotHexagonalGrid(){
		var margin = {
			top: 30,
			right: 20,
			bottom: 20,
			left: 50
		};

		var width = 850;
		var height = 350;
		var widtht = 850;
		var heightt = 350;

		var hexRadius=cellSize/2;	
		var hexInRadius;	
			

		//Set the new height and width of the SVG based on the max possible
		width = nbColumns*hexRadius*Math.sqrt(3);
		height = nbRows*1.5*hexRadius+0.5*hexRadius;

		widtht = nbColumns*hexInRadius*Math.sqrt(3);
		heightt = nbRows*1.5*hexInRadius+0.5*hexInRadius;


		//Set the hexagon radius
		var hexbin = d3.hexbin().radius(hexRadius);
			   
		var hexbint = d3.hexbin().radius(hexInRadius);
			   
		//Calculate the center positions of each hexagon	
		var points = [];
		for (var i = 0; i < nbRows; i++) {
			for (var j = 0; j < nbColumns; j++) {
				points.push([hexRadius * j * 1.75, hexRadius * i * 1.5]);
			}
		}

		//Calculate the center positions of each element in the hexagon
		var pointst = [];
		for (var i = 0; i < nbRows; i++) {
			for (var j = 0; j < nbColumns; j++) {
				pointst.push([(hexInRadius *j *1.75), hexInRadius *i*1.5]);
			}
		}

		var svg = d3.select("#theStar").append("svg")
			.attr("width", width+hexRadius+5)
			.attr("height", height)
			.attr("style"," display:block; margin:auto; margin-top:30px;")
			.append("g")
			.attr("transform", "translate(" + hexRadius + "," + hexRadius+ ")");

		var hexa = svg.selectAll(".hexagon")
			.data(hexbin(points))
			.enter().append("path")
			.attr("class", "hexagon")
			.attr("d", function (d) {
				return "M" + d.x + "," + d.y + hexbin.hexagon();
			})
			.attr("stroke", function (d,i) {
				return "#fff";
			})
			.attr("stroke-width", "1px")
			.style("fill", function (d,i) {
				var indice = superclass[i];
				return superclassColor[indice-1];
			});
		
		var coordinatesArray = hexbin(points);
		
		for (p = 0; p < nbRows*nbColumns; p++) {   
				
			var innerArrayNormalizedValues= starPlotNormalizedValues[p];	
			var innerArrayRealValues= starPlotRealValues[p];	
				
			var arrayValues = new Array(1);
			arrayValues[0] = new Array(nbSommet);
			for(var j=0; j<nbSommet; j++){
				arrayValues[0][j] = {axis: label[j], value: innerArrayNormalizedValues[j], realValue: innerArrayRealValues[j]};
			}
				
			// Dimension of the graph
			var w = cellSize*70/100,
				h = cellSize*70/100;
					
			//Options for the Radar chart, other than default
			var mycfg = {
				w: w,
				h: h,
				levels: 6,
				ExtraWidthX: cellSize,
				radius: cellSize*5/100,
				x: coordinatesArray[p].x+cellSize*15/100,
				y: coordinatesArray[p].y+cellSize*15/100
			}

			//Call function to draw the Radar chart
			//Will expect that data is in %'s
			RadarChart.draw("#theStar", arrayValues, mycfg);
			
			hexa.on('mouseover', function (d, i) {
				var el = d3.select(this)
					.transition()
					.duration(10)		  
					.style("fill-opacity", 0.8);
								
				d3.select('#Star-Info').text(function () {
					var ch = 'row: ' + parseInt((i/nbRows)+1,10) + ' | ' + 'column: ' + parseInt((i%nbRows)+1,10) + ' | ' + 'superclasse : ' + superclass[i];
					return ch;
					}); 
			});

			hexa.on('mouseout', function (d, i) {
				var el = d3.select(this)
					.transition()
					.duration(1000)
					.style("fill-opacity", 1);
			});
		}	
	}
  }
});
Shiny.outputBindings.register(histOutputBinding, 'just.testing');			
</script>	