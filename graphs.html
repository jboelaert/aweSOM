<a id="downloadLink">Download</a>
<img id="fromcanvasPlot" />

<script>

var histOutputBinding = new Shiny.OutputBinding();
$.extend(histOutputBinding, {
  find: function(scope) {
    return $(scope).find('.shiny-Plot');
  },
  renderValue: function(el, data) {
    document.getElementById("plot-message").style.textAlign = "center";

    //remove the old graph
    document.getElementById("thePlot").innerHTML = "";
    
    // Import common data
    if(data == null ) {return;}
    var plotType= data.plotType;
    var nbRows= data.gridInfo.nbLines;
    var nbColumns= data.gridInfo.nbColumns;
    var topology= data.gridInfo.topology;
    var saveToPng=data.saveToPng;
    var cellSize=data.sizeInfo;
    var w = cellSize*nbColumns;
    var h = cellSize*nbRows;
    var superclass = data.superclass;
    var superclassColor = data.superclassColor;

    // Plot-specific data
    if(plotType.localeCompare("Radar")==0) {
      // Radar
      var parts = data.parts;
      var label = data.label;
      var labelColor = data.labelColor;
      var radarNormalizedSize = data.radarNormalizedSize;
      var radarRealSize = data.radarRealSize;
      var radarNormalizedValues = data.radarNormalizedValues;
      var radarRealValues = data.radarRealValues;
    } else if(plotType.localeCompare("Camembert")==0) {
      // Pie
      var parts = data.parts;
      var label = data.label;
      var labelColor = data.labelColor;
      var pieNormalizedSize = data.pieNormalizedSize;
      var pieRealSize = data.pieRealSize;
      var pieNormalizedValues = data.pieNormalizedValues;
      var pieRealValues = data.pieRealValues;
    } else if(plotType.localeCompare("Barplot")==0) {
      // Barplot
      var nbBatons = data.nbBatons;
      var isHist = data.isHist;
	    var label = data.label;
	    var labelColor = data.labelColor;
	    var batonNormalizedValues = data.batonNormalizedValues;
	    var batonRealValues = data.batonRealValues;
    }


    
    // Plot download handler
    function downloadCanvas(link, filename) {
      var division = document.getElementById("thePlot");
      var svg = division.children[0];
      var img = document.getElementById("fromcanvasPlot");
      
      if(saveToPng){
        svg.toDataURL("image/png", {
          callback: function(data) {
            link.href = data;
            link.download = filename;
          }
        })
      } else {
        svg.toDataURL("image/svg+xml", {
          callback: function(data) {
            link.href = data;
            link.download = filename;
          }
        })
      }
    }
    document.getElementById('downloadLink').addEventListener('click', function() {
      if(saveToPng){
        downloadCanvas(this, 'somplot.png');
      }else{
        downloadCanvas(this, 'somplot.svg');
      }
    }, false);
    
    // Call grid following topology and type
    if(topology.localeCompare('rectangular')==0){
      commonSquareGrid();
      // if(plotType.localeCompare("Radar")==0) radarSquareSizeGrid();
      // if(plotType.localeCompare("Camembert")==0) pieSquareGrid();
    }else if(topology.localeCompare('hexagonal')==0){
      commonHexGrid();
      // if(plotType.localeCompare("Radar")==0) radarHexagonalGrid();
      // if(plotType.localeCompare("Camembert")==0) pieHexagonalGrid();
    }

    
    ////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////
    // Square grid function
    ////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////
    function commonSquareGrid(){
      var svg = d3.select('#thePlot').append('svg')
      .attr("style"," display:block; margin:auto; margin-top:30px")
      .attr({width: w, height: h});
      
      // Loop on rows
      _.times(nbRows, function(n) {
        var rows = svg.selectAll('rect' + ' .row-' + (n + 1))
        .data(d3.range(nbColumns))
  			.enter().append('rect')
				.attr({
					class: function(d, i) {
						return 'square row-' + (n + 1) + ' ' + 'col-' + (i + 1);
					},
					id: function(d, i) {
						return 's-' + (n + 1) + (i + 1);
					},
					width: cellSize,
					height: cellSize,
					x: function(d, i) {
						return i * cellSize;
					},
					y: n * cellSize,
					fill: function(d, i) {
						var indice = superclass[(n*nbColumns)+i];
						return superclassColor[indice-1];
					},
					stroke: '#FDBB30'
				});
        
        svg.selectAll('rect' + ' .row-' + (n + 1))
        .data(d3.range(nbColumns))
				.append('g')
        
        if (plotType.localeCompare("Radar")==0) {
          //////////////////////////////////////////////////////////////////////
          // Square Radar
          ///////////////////////////////////////////////////////////////////////
          var array = d3.range(nbColumns);
          var width = cellSize*.5;
          var height = cellSize*.5;
          var radius = Math.min(width, height) / 2;
          for (p = 0; p < array.length; p++) {
            var arc = d3.svg.arc().outerRadius(function function_name(d,i) { 
              return d.data.normalizedValue*0.4;});
            var innerArrayNormalizedValues = [];
            innerArrayNormalizedValues= radarNormalizedValues[(n*nbColumns)+p];
            var innerArrayRealValues = [];
            innerArrayRealValues= radarRealValues[(n*nbColumns)+p];
            
            var arrayValues = [];
            for(var j=0; j<parts; j++){
              arrayValues[j] = [];
              arrayValues[j].normalizedValue = innerArrayNormalizedValues[j]*cellSize;
              arrayValues[j].realValue = innerArrayRealValues[j];
            }
            
            var pie = d3.layout.pie()
            .value(function(d) {  return 100/parts; })
            .sort(null);
            
            var pieParts = svg.selectAll('rect' + ' .row-' + (n + 1))
            .data(pie(arrayValues))
    				.enter()
  					.append('path')
  					.attr('d', arc)
  					.attr('transform', 'translate(' + (array[p] * cellSize + cellSize/2) +
  						',' + (n * cellSize + cellSize/2) + ')')
  					.attr('fill', function(d, i) {
  						return labelColor[i];
  					});
            
            // Mouse actions
            rows.on('mouseover', function (d, i) {
              var el = d3.select(this)
              .transition()
  						.duration(10)		  
  						.style("fill-opacity", 0.8);
  						
              d3.select('#plot-message').text(function () {
                var ch = 'row: ' + (n + 1) + ' | ' + 'column: ' + (i + 1) + ' | ' + 'size: ' + radarRealSize[(n*nbColumns)+i] + ' | ';
                return ch;
              });
            });
            rows.on('mouseout', function (d, i) {
              var el = d3.select(this)
              .transition()
              .duration(1000)
              .style("fill-opacity", 1);
            });
            pieParts.on('mouseenter', function (d, i) {
              d3.select('#plot-message').text(function () { 
                var innerArrayRealValues = [];
                var ch=label[i]+": " + d.data.realValue;
                return ch;	
              }); 	
              d3.select(this)
  						.attr("stroke","white")
  						.transition()
  						.duration(50)
  						.attr("stroke-width",2);
            });
            pieParts.on('mouseleave', function (d, i) {
              d3.select(this).transition()
  						.duration(50)
  						.attr("stroke","none");
            });
          }
        } else if (plotType.localeCompare("Camembert")==0) {
          //////////////////////////////////////////////////////////////////////
          // Square Pie
          ///////////////////////////////////////////////////////////////////////
          var array = d3.range(nbColumns);
          var width = cellSize*.5;
          var height = cellSize*.5;
          var radius = Math.min(width, height) / 2;
          for (p = 0; p < array.length; p++) {
            var arc = d3.svg.arc().outerRadius(pieNormalizedSize[(n*nbColumns)+p]*(cellSize*50/100));
            var innerArrayNormalizedValues = [];
            innerArrayNormalizedValues= pieNormalizedValues[(n*nbColumns)+p];
            var innerArrayRealValues = [];
            innerArrayRealValues= pieRealValues[(n*nbColumns)+p];
  						
  					var arrayValues = [];
  					for(var j=0; j<parts; j++){
  						arrayValues[j] = [];
  						arrayValues[j].normalizedValue = innerArrayNormalizedValues[j]*cellSize;
  						arrayValues[j].realValue = innerArrayRealValues[j];
  					}
  						
  					var pie = d3.layout.pie()
  						.value(function(d) { return d.normalizedValue; })
  						.sort(null);
  						
  					var pieParts = svg.selectAll('rect' + ' .row-' + (n + 1))
  						.data(pie(arrayValues))
  						.enter()
  						.append('path')
  						.attr('d', arc)
  						.attr('transform', 'translate(' + (array[p] * cellSize + cellSize/2) + ',' + (n * cellSize + cellSize/2) + ')')
  						.attr('fill', function(d, i) { 
  							return labelColor[i];
  						});
  
  					rows.on('mouseover', function (d, i) {
  						var el = d3.select(this)
              .transition()
              .duration(10)		  
              .style("fill-opacity", 0.8);
              
              d3.select('#plot-message').text(function () {
  							var v = (n*nbColumns)+i;
  							var ch = 'row: ' + (n + 1) + ' | ' + 'column: ' + (i + 1) + ' | ' + 'size: ' + pieRealSize[(n*nbColumns)+i];
  							return ch;
  						}); 
  					});
            rows.on('mouseout', function (d, i) {
  						var el = d3.select(this)
  							.transition()
  							.duration(1000)
  							.style("fill-opacity", 1);
  					});
            pieParts.on('mouseenter', function (d, i) {
  						d3.select('#plot-message').text(function () { 
  								var ch=label[i]+": " + d.data.realValue;
  								return ch;	
  						}); 	
  						d3.select(this)
              .attr("stroke","white")
              .transition()
              .duration(50)
              .attr("stroke-width",1);
            });
            pieParts.on('mouseleave', function (d, i) {
  						d3.select(this).transition()
              .duration(50)
              .attr("stroke","none");
            });
          }
        } else if (plotType.localeCompare("Barplot")==0) {
          //////////////////////////////////////////////////////////////////////
          // Square Barplot
          ///////////////////////////////////////////////////////////////////////
          var k=0;
      		var array = d3.range(nbColumns);
    			var width = cellSize;
    			var height = cellSize*.6;			
          for (var cpt = 0; cpt < array.length; cpt++) { 	
    					
    				var innerArrayNormalizedValues= batonNormalizedValues[(n*nbColumns)+cpt];
    				var innerArrayRealValues= batonRealValues[(n*nbColumns)+cpt];
    					
    				var arrayValues = [];
    				for(var j=0; j<nbBatons; j++){
    					arrayValues[j] = [];
    					arrayValues[j].normalizedValue = innerArrayNormalizedValues[j]*cellSize;
    					arrayValues[j].realValue = innerArrayRealValues[j];
    				}	
    							
    				var y = d3.scale.linear()
    					.domain([0,nbBatons])
    					.range([0,height])
    						
    				var x = d3.scale.linear()
    					.domain([0,nbBatons])
    					.range([0,width])
    							
    							
    				var xAxis = d3.svg.axis()
    					.scale(x)
    					.orient("bottom");
    					
    				var layout = d3.layout.pie()
    						.value(function(d) { return d.normalizedValue; })
    						.sort(null);
    					
    				var bars = svg.selectAll('rect' + ' .row-' + (n + 1))
    					.data(layout(arrayValues))
    					.enter()
    					.append("rect")
    					.attr("class", function(d, i) { 
    						return "r"+i;
    					})
    					.attr("x", function (d, i) { 
    						return i*((width-(cellSize*40/100))/nbBatons)+k+(cellSize*20/100); 
    					})
    					.attr("y", function (d, i) { return cellSize - (cellSize*5/100) - innerArrayNormalizedValues[i]*cellSize +n*cellSize; })
    					.attr("width", function (d) { return ((width-(cellSize*40/100))/nbBatons)-(cellSize*2/100)})
    					.attr("height", function (d, i) {return innerArrayNormalizedValues[i]*cellSize; })
    					.attr("fill", function(d, i) {
    							return labelColor[i];
    					});
    					k+=cellSize;	
    					
    				rows.on('mouseover', function (d, i) {	
    					d3.select('#plot-message').text(function () {
    						var ch = 'row: ' + (n + 1) + ' | ' + 'column: ' + (i + 1) + ' | ' + 'superclasse : ' + superclass[(n*nbColumns)+i];
    						return ch;
    						});
    						
    					var el = d3.select(this)
    						.transition()
    						.duration(10)		  
    						.style("fill-opacity", 0.8);		 
    				});
    
    				rows.on('mouseout', function (d, i) {
    					var el = d3.select(this)
    						.transition()
    						.duration(1000)
    						.style("fill-opacity", 1);
    				});				
    				
    				bars.on('mouseenter', function (d, i) {
    					d3.select('#plot-message').text(function () { 
    						var ch=label[i]+": " + d.data.realValue;
    						return ch;	
    					});
    						
    					console.log(bars[0]);
    					
    					svg.selectAll("rect.r"+i)
    						.attr("stroke","white")
    						.transition()
    						.duration(50)
    						.attr("stroke-width",2);
    				});
    
    				bars.on('mouseleave', function (d, i) {
    					svg.selectAll("rect.r"+i).transition()
    						.duration(50)
    						.attr("stroke","none");
    				});	
    			}
        }
      });
    }


    ////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////
    // Hexagonal grid function
    ////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////
    function commonHexGrid(){
      var margin = {top: 30, right: 20, bottom: 20, left: 50};
      var width = 850;
      var height = 350;
      var widtht = 850;
      var heightt = 350;
      var hexRadius=cellSize/2;  
      var hexInRadius;	
			
      //Set the new height and width of the SVG based on the max possible
      width = nbColumns*hexRadius*Math.sqrt(3);
      height = nbRows*1.5*hexRadius+0.5*hexRadius;
      //Set the hexagon radius
      var hexbin = d3.hexbin().radius(hexRadius);
      //Calculate the center positions of each hexagon	
      var points = [];
      for (var i = 0; i < nbRows; i++) {
        for (var j = 0; j < nbColumns; j++) {
          points.push([hexRadius * j * 1.75, hexRadius * i * 1.5]);
        }
      }
      
      var svg = d3.select("#thePlot").append("svg")
			.attr("width", width+hexRadius+5)
			.attr("height", height)
			.attr("style"," display:block; margin:auto; margin-top:30px;")
			.append("g")
			.attr("transform", "translate(" + hexRadius + "," + hexRadius+ ")");
      
      var hexa = svg.selectAll(".hexagon")
			.data(hexbin(points))
			.enter().append("path")
			.attr("class", "hexagon")
			.attr("d", function (d) {
				return "M" + d.x + "," + d.y + hexbin.hexagon();
			})
			.attr("stroke", function (d,i) {
				return "#fff";
			})
			.attr("stroke-width", "1px")
			.style("fill", function (d,i) {
				var indice = superclass[i];
				return superclassColor[indice-1];
			});
      
      var array = d3.range(nbColumns);
      var width = hexRadius;
      var height = hexRadius;
      var radius = Math.min(width, height)/ 2;
      
      svg.selectAll(".hexagon").data(d3.range(nbColumns)).append('g')
      var coordinatesArray = hexbin(points);
      
      if (plotType.localeCompare("Radar")==0) {
        //////////////////////////////////////////////////////////////////////////
        // Hexagonal Radar
        //////////////////////////////////////////////////////////////////////////
        var array = d3.range(nbColumns);
        var width = cellSize*.5;
        var height = cellSize*.5;
        var radius = Math.min(width, height) / 2;
        for (var n = 0; n < nbRows*nbColumns; n++) {
          var arc = d3.svg.arc().outerRadius(function function_name(d,i) { return d.data.normalizedValue*0.4;});
          var innerArrayNormalizedValues = [];
          innerArrayNormalizedValues= radarNormalizedValues[n];	
          var innerArrayRealValues = [];
          innerArrayRealValues= radarRealValues[n];
          var arrayValues = [];
          
          for(var j=0; j<parts; j++){
            arrayValues[j] = [];
            arrayValues[j].normalizedValue = innerArrayNormalizedValues[j]*cellSize;
            arrayValues[j].realValue = innerArrayRealValues[j];
          }
          
          var pie = d3.layout.pie()
          .value(function(d) { return 100/parts; })
          .sort(null);
          
          var pieParts = svg.append("g")
  				.selectAll(".hexagon")
  				.data(pie(arrayValues))
  				.enter()
  				.append('path')
  				.attr("class", "pie")
  				.attr('d', arc)
  				.attr('transform', 'translate(' + (coordinatesArray[n].x) +',' + coordinatesArray[n].y + ')')
  				.attr('fill', function(d, i) {
  					return labelColor[i];
  				})
          
          // Mouse actions
          hexa.on('mouseover', function (d, i) {
  				var el = d3.select(this)
  					.transition()
  					.duration(10)		  
  					.style("fill-opacity", 0.8);
            
            d3.select('#plot-message').text(function () {
              var ch = 'row: ' + parseInt((i/nbRows)+1,10) + ' | ' + 'column: ' + parseInt((i%nbRows)+1,10) + ' | ' + 'size: ' + radarRealSize[i];
              return ch;
            }); 
          });
          hexa.on('mouseout', function (d, i) {
            var el = d3.select(this)
  					.transition()
  					.duration(1000)
  					.style("fill-opacity", 1);
          });
          pieParts.on('mouseenter', function (d, i) {
            d3.select('#plot-message').text(function () { 
              var innerArrayRealValues = [];
              var ch=label[i]+": " + d.data.realValue;
              return ch;
            });
            d3.select(this)
            .attr("stroke","white")
            .transition()
            .duration(50)
            .attr("stroke-width",2);
          });
          pieParts.on('mouseleave', function (d, i) {
            d3.select(this).transition()
            .duration(50)
            .attr("stroke","none");
          });
        }
      } else if(plotType.localeCompare("Camembert")==0) {
        //////////////////////////////////////////////////////////////////////////
        // Hexagonal Pie
        //////////////////////////////////////////////////////////////////////////
        var array = d3.range(nbColumns);
        var width = cellSize*.5;
        var height = cellSize*.5;
        var radius = Math.min(width, height) / 2;
        for (var n = 0; n < nbRows*nbColumns; n++) {
  				var arc = d3.svg.arc().outerRadius(pieNormalizedSize[n]*(cellSize*40/100));
  				
  				var innerArrayNormalizedValues = [];
  				innerArrayNormalizedValues= pieNormalizedValues[n];	
  				
  				var innerArrayRealValues = [];
  				innerArrayRealValues= pieRealValues[n];
  				var arrayValues = [];
  				
  				for(var j=0; j<parts; j++){
  					arrayValues[j] = [];
  					arrayValues[j].normalizedValue = innerArrayNormalizedValues[j]*cellSize;
  					arrayValues[j].realValue = innerArrayRealValues[j];
  				}
  
  				var pie = d3.layout.pie()
  					.value(function(d) { return d.normalizedValue; })
  					.sort(null);
  
  				var pieParts = svg.append("g")
  					.selectAll(".hexagon")
  					.data(pie(arrayValues))
  					.enter()
  					.append('path')
  					.attr("class", "pie")
  					.attr('d', arc)
  					.attr('transform', 'translate(' + (coordinatesArray[n].x) +',' + coordinatesArray[n].y + ')')
  					.attr('fill', function(d, i) {
  						return labelColor[i];
  					})	
  					
  				hexa.on('mouseover', function (d, i) {
  					var el = d3.select(this)
  						.transition()
  						.duration(10)		  
  						.style("fill-opacity", 0.8);
  									
  					d3.select('#plot-message').text(function () {
  						var ch = 'row: ' + parseInt((i/nbRows)+1,10) + ' | ' + 'column: ' + parseInt((i%nbRows)+1,10) + ' | ' + 'size: ' + pieRealSize[i];
  						return ch;
  					}); 
  				});
  				hexa.on('mouseout', function (d, i) {
  					var el = d3.select(this)
  						.transition()
  						.duration(1000)
  						.style("fill-opacity", 1);
  					});
          pieParts.on('mouseenter', function (d, i) {
  					d3.select('#plot-message').text(function () { 
  						var ch=label[i]+": " + d.data.realValue;
  						return ch;	
  					});
            d3.select(this)
  						.attr("stroke","white")
  						.transition()
  						.duration(50)
  						.attr("stroke-width",1);
  				});
          pieParts.on('mouseleave', function (d, i) {
  					d3.select(this).transition()
  						.duration(50)
  						.attr("stroke","none");
  				});
  			}	
      } else if(plotType.localeCompare("Barplot")==0) {
        //////////////////////////////////////////////////////////////////////////
        // Hexagonal Barplot
        //////////////////////////////////////////////////////////////////////////
      	var array = d3.range(nbColumns);
  			var width = cellSize;
  			var height = cellSize*.6;			
      	for (var indice = 0; indice < nbRows*nbColumns; indice++) {
          var innerArrayNormalizedValues= batonNormalizedValues[indice];
          var innerArrayRealValues= batonRealValues[indice];
          var arrayValues = [];
          for(var j=0; j<nbBatons; j++){
    				arrayValues[j] = [];
    				arrayValues[j].normalizedValue = innerArrayNormalizedValues[j]*cellSize;
    				arrayValues[j].realValue = innerArrayRealValues[j];
    			}
          var y = d3.scale.linear()
    				.domain([0,nbBatons])
    				.range([0,height])
    						
    			var x = d3.scale.linear()
    				.domain([0,nbBatons])
    				.range([0,width])
    					
    			var layout = d3.layout.pie()
    					.value(function(d) { return d.normalizedValue; })
    					.sort(null);
    					
    			var bars = svg.append("g").selectAll(".hexagon")
    				.data(layout(arrayValues))
    				.enter()
    				.append("rect")
    				.attr("class", function(d, i) { 
    					return "r"+i;
    				})
    				.attr("x", function (d, i) { 
    					return i*((width-(cellSize*40/100))/nbBatons)+(cellSize*20/100); 
    				})
    				.attr("y", function (d, i) { return -innerArrayNormalizedValues[i]*(cellSize*55/100)+cellSize*25/100; })
    				.attr("width", function (d) { return ((width-(cellSize*40/100))/nbBatons)-(cellSize*2/100)})
    				.attr("height", function (d, i) {return innerArrayNormalizedValues[i]*cellSize*55/100; })
    				.attr('transform', 'translate(' + (coordinatesArray[indice].x-cellSize/2) + ',' + (coordinatesArray[indice].y) + ')')
    				.attr("fill", function(d, i) {
    						return labelColor[i];
    				});
    			
    			hexa.on('mouseover', function (d, i) {	
    				d3.select('#plot-message').text(function () {
    					var indice = (parseInt((i/nbRows),10)*nbColumns)+ parseInt((i%nbRows),10);
    					var ch = 'row: ' + parseInt((i/nbRows)+1,10) + ' | ' + 'column: ' + parseInt((i%nbRows)+1,10) + ' | ' + 'superclasse : ' + superclass[indice];
    					return ch;
    					});
    					
    				var el = d3.select(this)
    					.transition()
    					.duration(10)		  
    					.style("fill-opacity", 0.8);		 
    			});
    
    			hexa.on('mouseout', function (d, i) {
    				var el = d3.select(this)
    					.transition()
    					.duration(1000)
    					.style("fill-opacity", 1);
    			});				
    			bars.on('mouseenter', function (d, i) {
    				d3.select('#plot-message').text(function () { 
    					var ch=label[i]+": " + d.data.realValue;
    					return ch;	
    				});
    				svg.selectAll("rect.r"+i)
    					.attr("stroke","white")
    					.transition()
    					.duration(50)
    					.attr("stroke-width",2);
    			});
    			bars.on('mouseleave', function (d, i) {
    				svg.selectAll("rect.r"+i).transition()
    						.duration(50)
    						.attr("stroke","none");
    			});	
    					
    		}
      }
    }
    
    ////////////////////////////////////////////////////////////////////////////
    // Radar functions
    ////////////////////////////////////////////////////////////////////////////
    function radarSquareSizeGrid(){
      var svg = d3.select('#thePlot').append('svg')
      .attr("style"," display:block; margin:auto; margin-top:30px")
      .attr({width: w, height: h});
      
      // Loop on rows
      _.times(nbRows, function(n) {
        var rows = svg.selectAll('rect' + ' .row-' + (n + 1))
        .data(d3.range(nbColumns))
				.enter().append('rect')
				.attr({
					class: function(d, i) {
						return 'square row-' + (n + 1) + ' ' + 'col-' + (i + 1);
					},
					id: function(d, i) {
						return 's-' + (n + 1) + (i + 1);
					},
					width: cellSize,
					height: cellSize,
					x: function(d, i) {
						return i * cellSize;
					},
					y: n * cellSize,
					fill: function(d, i) {
						var indice = superclass[(n*nbColumns)+i];
						return superclassColor[indice-1];
					},
					stroke: '#FDBB30'
				});
        
        var array = d3.range(nbColumns);
        var width = cellSize*50/100;
        var height = cellSize*50/100;
        var radius = Math.min(width, height) / 2;
        
        svg.selectAll('rect' + ' .row-' + (n + 1))
        .data(d3.range(nbColumns))
				.append('g')
        
        // Inner loop on columns
        for (p = 0; p < array.length; p++) {
          var arc = d3.svg.arc().outerRadius(function function_name(d,i) { return d.data.normalizedValue*0.4;});
          var innerArrayNormalizedValues = [];
          innerArrayNormalizedValues= radarNormalizedValues[(n*nbColumns)+p];
          var innerArrayRealValues = [];
          innerArrayRealValues= radarRealValues[(n*nbColumns)+p];
          
          var arrayValues = [];
          for(var j=0; j<parts; j++){
            arrayValues[j] = [];
            arrayValues[j].normalizedValue = innerArrayNormalizedValues[j]*cellSize;
            arrayValues[j].realValue = innerArrayRealValues[j];
          }
          
          var pie = d3.layout.pie()
          .value(function(d) {  return 100/parts; })
          .sort(null);
          
          var pieParts = svg.selectAll('rect' + ' .row-' + (n + 1))
          .data(pie(arrayValues))
					.enter()
					.append('path')
					.attr('d', arc)
					.attr('transform', 'translate(' + (array[p] * cellSize + cellSize/2) +
						',' + (n * cellSize + cellSize/2) + ')')
					.attr('fill', function(d, i) {
						return labelColor[i];
					});
          
          // Mouse actions
          rows.on('mouseover', function (d, i) {
            var el = d3.select(this)
            .transition()
						.duration(10)		  
						.style("fill-opacity", 0.8);
						
            d3.select('#plot-message').text(function () {
              var ch = 'row: ' + (n + 1) + ' | ' + 'column: ' + (i + 1) + ' | ' + 'size: ' + radarRealSize[(n*nbColumns)+i] + ' | ';
              return ch;
            });
          });
          rows.on('mouseout', function (d, i) {
            var el = d3.select(this)
            .transition()
						.duration(1000)
						.style("fill-opacity", 1);
          });
          pieParts.on('mouseenter', function (d, i) {
					d3.select('#plot-message').text(function () { 
						var innerArrayRealValues = [];
						var ch=label[i]+": " + d.data.realValue;
						return ch;	
					}); 	
					d3.select(this)
						.attr("stroke","white")
						.transition()
						.duration(50)
						.attr("stroke-width",2);
          });
          pieParts.on('mouseleave', function (d, i) {
            d3.select(this).transition()
						.duration(50)
						.attr("stroke","none");
          });
        }
      });
    }
    
    function radarHexagonalGrid(){
      var margin = {top: 30, right: 20, bottom: 20, left: 50};
      var width = 850;
      var height = 350;
      var widtht = 850;
      var heightt = 350;
      var hexRadius=cellSize/2;	
      var hexInRadius;	
			
      //Set the new height and width of the SVG based on the max possible
      width = nbColumns*hexRadius*Math.sqrt(3);
      height = nbRows*1.5*hexRadius+0.5*hexRadius;
      //Set the hexagon radius
      var hexbin = d3.hexbin().radius(hexRadius);
      //Calculate the center positions of each hexagon	
      var points = [];
      for (var i = 0; i < nbRows; i++) {
        for (var j = 0; j < nbColumns; j++) {
          points.push([hexRadius * j * 1.75, hexRadius * i * 1.5]);
        }
      }
      
      var svg = d3.select("#thePlot").append("svg")
			.attr("width", width+hexRadius+5)
			.attr("height", height)
			.attr("style"," display:block; margin:auto; margin-top:30px;")
			.append("g")
			.attr("transform", "translate(" + hexRadius + "," + hexRadius+ ")");
      
      var hexa = svg.selectAll(".hexagon")
			.data(hexbin(points))
			.enter().append("path")
			.attr("class", "hexagon")
			.attr("d", function (d) {
				return "M" + d.x + "," + d.y + hexbin.hexagon();
			})
			.attr("stroke", function (d,i) {
				return "#fff";
			})
			.attr("stroke-width", "1px")
			.style("fill", function (d,i) {
				var indice = superclass[i];
				return superclassColor[indice-1];
			});
      
      var array = d3.range(nbColumns);
      var width = hexRadius;
      var height = hexRadius;
      var radius = Math.min(width, height)/ 2;
      
      svg.selectAll(".hexagon").data(d3.range(nbColumns)).append('g')
      var coordinatesArray = hexbin(points);
      
      // Loop on cells
      for (var n = 0; n < nbRows*nbColumns; n++) {
        var arc = d3.svg.arc().outerRadius(function function_name(d,i) { return d.data.normalizedValue*0.4;});
        var innerArrayNormalizedValues = [];
        innerArrayNormalizedValues= radarNormalizedValues[n];	
        var innerArrayRealValues = [];
        innerArrayRealValues= radarRealValues[n];
        var arrayValues = [];
        
        for(var j=0; j<parts; j++){
          arrayValues[j] = [];
          arrayValues[j].normalizedValue = innerArrayNormalizedValues[j]*cellSize;
          arrayValues[j].realValue = innerArrayRealValues[j];
        }
        
        var pie = d3.layout.pie()
				.value(function(d) { return 100/parts; })
				.sort(null);
        
        var pieParts = svg.append("g")
				.selectAll(".hexagon")
				.data(pie(arrayValues))
				.enter()
				.append('path')
				.attr("class", "pie")
				.attr('d', arc)
				.attr('transform', 'translate(' + (coordinatesArray[n].x) +',' + coordinatesArray[n].y + ')')
				.attr('fill', function(d, i) {
					return labelColor[i];
				})
        
        // Mouse actions
        hexa.on('mouseover', function (d, i) {
				var el = d3.select(this)
					.transition()
					.duration(10)		  
					.style("fill-opacity", 0.8);
          
          d3.select('#plot-message').text(function () {
            var ch = 'row: ' + parseInt((i/nbRows)+1,10) + ' | ' + 'column: ' + parseInt((i%nbRows)+1,10) + ' | ' + 'size: ' + radarRealSize[i];
            return ch;
          }); 
        });
        hexa.on('mouseout', function (d, i) {
          var el = d3.select(this)
					.transition()
					.duration(1000)
					.style("fill-opacity", 1);
        });
        pieParts.on('mouseenter', function (d, i) {
          d3.select('#plot-message').text(function () { 
            var innerArrayRealValues = [];
            var ch=label[i]+": " + d.data.realValue;
            return ch;
          });
          d3.select(this)
					.attr("stroke","white")
					.transition()
					.duration(50)
					.attr("stroke-width",2);
        });
        pieParts.on('mouseleave', function (d, i) {
          d3.select(this).transition()
          .duration(50)
					.attr("stroke","none");
        });
      }
    }
    
    ////////////////////////////////////////////////////////////////////////////
    // Pie functions
    ////////////////////////////////////////////////////////////////////////////
    // Square Pie
    function pieSquareGrid(){
			var svg = d3.select('#thePlot').append('svg')
				.attr("style"," display:block; margin:auto; margin-top:30px;")
				.attr({
					width: w,
					height: h
				});
  
			_.times(nbRows, function(n) {
				
				var rows = svg.selectAll('rect' + ' .row-' + (n + 1))
					.data(d3.range(nbColumns))
					.enter().append('rect')
					.attr({
						class: function(d, i) {
							return 'square row-' + (n + 1) + ' ' + 'col-' + (i + 1);
						},
						id: function(d, i) {
							return 's-' + (n + 1) + (i + 1);
						},
						width: cellSize,
						height: cellSize,
						x: function(d, i) {
							return i * cellSize;
						},
						y: n * cellSize,
						fill: function(d, i) {
							var indice = superclass[(n*nbColumns)+i];
							return superclassColor[indice-1];
						},
						stroke: '#FDBB30'
					});

				var array = d3.range(nbColumns);
				var width = cellSize*50/100;
				var height = cellSize*50/100;
				var radius = Math.min(width, height) / 2;

				svg.selectAll('rect' + ' .row-' + (n + 1))
					 .data(d3.range(nbColumns))
					 .append('g')
							  
				for (p = 0; p < array.length; p++) {   
					var arc = d3.svg.arc().outerRadius(pieNormalizedSize[(n*nbColumns)+p]*(cellSize*50/100));
					  
					var innerArrayNormalizedValues = [];
					innerArrayNormalizedValues= pieNormalizedValues[(n*nbColumns)+p];
						
					var innerArrayRealValues = [];
					innerArrayRealValues= pieRealValues[(n*nbColumns)+p];
						
					var arrayValues = [];
					for(var j=0; j<parts; j++){
						arrayValues[j] = [];
						arrayValues[j].normalizedValue = innerArrayNormalizedValues[j]*cellSize;
						arrayValues[j].realValue = innerArrayRealValues[j];
					}
						
					var pie = d3.layout.pie()
						.value(function(d) { return d.normalizedValue; })
						.sort(null);
						
					var pieParts = svg.selectAll('rect' + ' .row-' + (n + 1))
						.data(pie(arrayValues))
						.enter()
						.append('path')
						.attr('d', arc)
						.attr('transform', 'translate(' + (array[p] * cellSize + cellSize/2) + ',' + (n * cellSize + cellSize/2) + ')')
						.attr('fill', function(d, i) { 
							return labelColor[i];
						});

					rows.on('mouseover', function (d, i) {
						var el = d3.select(this)
							.transition()
							.duration(10)		  
							.style("fill-opacity", 0.8);
									
						d3.select('#plot-message').text(function () {
							var v = (n*nbColumns)+i;
							var ch = 'row: ' + (n + 1) + ' | ' + 'column: ' + (i + 1) + ' | ' + 'size: ' + pieRealSize[(n*nbColumns)+i];
							return ch;
						}); 
					});

					rows.on('mouseout', function (d, i) {
						var el = d3.select(this)
							.transition()
							.duration(1000)
							.style("fill-opacity", 1);
					});
							
					pieParts.on('mouseenter', function (d, i) {
						d3.select('#plot-message').text(function () { 
								var ch=label[i]+": " + d.data.realValue;
								return ch;	
						}); 	
									
						d3.select(this)
							.attr("stroke","white")
							.transition()
							.duration(50)
							.attr("stroke-width",1);
						});

					pieParts.on('mouseleave', function (d, i) {
						d3.select(this).transition()
							.duration(50)
							.attr("stroke","none");
						});
					}  
			});
		}
    
    // Hexagonal Pie
  	function pieHexagonalGrid(){
			var margin = {top: 30, right: 20, bottom: 20, left: 50};
			var width = 850;
			var height = 350;
			var widtht = 850;
			var heightt = 350;
			var hexRadius=cellSize/2;	
			var hexInRadius;	
			
			//Set the new height and width of the SVG based on the max possible
			width = nbColumns*hexRadius*Math.sqrt(3);
			height = nbRows*1.5*hexRadius+0.5*hexRadius;
			//Set the hexagon radius
			var hexbin = d3.hexbin().radius(hexRadius);
			//Calculate the center positions of each hexagon	
			var points = [];
			for (var i = 0; i < nbRows; i++) {
				for (var j = 0; j < nbColumns; j++) {
					points.push([hexRadius * j * 1.75, hexRadius * i * 1.5]);
				}
			}

			var svg = d3.select("#thePlot").append("svg")
				.attr("width", width+hexRadius+5)
				.attr("height", height)
				.attr("style"," display:block; margin:auto; margin-top:30px;")
				.append("g")
				.attr("transform", "translate(" + hexRadius + "," + hexRadius+ ")");

			var hexa = svg.selectAll(".hexagon")
				.data(hexbin(points))
				.enter().append("path")
				.attr("class", "hexagon")
				.attr("d", function (d) {
					return "M" + d.x + "," + d.y + hexbin.hexagon();
				})
				.attr("stroke", function (d,i) {
					return "#fff";
				})
				.attr("stroke-width", "1px")
				.style("fill", function (d,i) {
					var indice = superclass[i];
					return superclassColor[indice-1];
				});
        
        var array = d3.range(nbColumns);
        var width = hexRadius;
        var height = hexRadius;
        var radius = Math.min(width, height)/ 2;
        
        svg.selectAll(".hexagon").data(d3.range(nbColumns)).append('g')
        
        var coordinatesArray = hexbin(points);
        
        for (var n = 0; n < nbRows*nbColumns; n++) {
				
				var arc = d3.svg.arc().outerRadius(pieNormalizedSize[n]*(cellSize*40/100));
				
				var innerArrayNormalizedValues = [];
				innerArrayNormalizedValues= pieNormalizedValues[n];	
				
				var innerArrayRealValues = [];
				innerArrayRealValues= pieRealValues[n];
				var arrayValues = [];
				
				for(var j=0; j<parts; j++){
					arrayValues[j] = [];
					arrayValues[j].normalizedValue = innerArrayNormalizedValues[j]*cellSize;
					arrayValues[j].realValue = innerArrayRealValues[j];
				}

				var pie = d3.layout.pie()
					.value(function(d) { return d.normalizedValue; })
					.sort(null);

				var pieParts = svg.append("g")
					.selectAll(".hexagon")
					.data(pie(arrayValues))
					.enter()
					.append('path')
					.attr("class", "pie")
					.attr('d', arc)
					.attr('transform', 'translate(' + (coordinatesArray[n].x) +',' + coordinatesArray[n].y + ')')
					.attr('fill', function(d, i) {
						return labelColor[i];
					})	
					
				hexa.on('mouseover', function (d, i) {
					var el = d3.select(this)
						.transition()
						.duration(10)		  
						.style("fill-opacity", 0.8);
									
					d3.select('#plot-message').text(function () {
						var ch = 'row: ' + parseInt((i/nbRows)+1,10) + ' | ' + 'column: ' + parseInt((i%nbRows)+1,10) + ' | ' + 'size: ' + pieRealSize[i];
						return ch;
					}); 
				});

				hexa.on('mouseout', function (d, i) {
					var el = d3.select(this)
						.transition()
						.duration(1000)
						.style("fill-opacity", 1);
					});
							
				pieParts.on('mouseenter', function (d, i) {
					d3.select('#plot-message').text(function () { 
						var ch=label[i]+": " + d.data.realValue;
						return ch;	
					}); 	
									
					d3.select(this)
						.attr("stroke","white")
						.transition()
						.duration(50)
						.attr("stroke-width",1);
				});

				pieParts.on('mouseleave', function (d, i) {
					d3.select(this).transition()
						.duration(50)
						.attr("stroke","none");
				});
			}		
		}
  }
});
Shiny.outputBindings.register(histOutputBinding, 'kohcorico');			
</script>	