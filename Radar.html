<header>
  <h4 id="Radar-Info"></h4>
</header>

<a id="downloadRadar"></a>
<img id="fromcanvasRadar" />

<script>

var histOutputBinding = new Shiny.OutputBinding();

  $.extend(histOutputBinding, {
    find: function(scope) {
      return $(scope).find('.shiny-Radar');
    },
    renderValue: function(el, data) {
    //remove the old graph
	document.getElementById("theRadar").innerHTML = "";
	if(data == null ) {return;}
	
	var nbRows=data.gridInfo.nbLines;
	var nbColumns=data.gridInfo.nbColumns;
	var topology = data.gridInfo.topology;
	var superclass = data.superclass;
	var superclassColor = data.superclassColor;
	var parts = data.parts;
	var label = data.label;
	var labelColor = data.labelColor;
	var radarNormalizedSize = data.radarNormalizedSize;
	var radarRealSize = data.radarRealSize;
	var radarNormalizedValues = data.radarNormalizedValues;
	var radarRealValues = data.radarRealValues;
	var cellSize=data.sizeInfo;
	var saveToPng=data.saveToPng;
	var w = cellSize*nbColumns;
	var h = cellSize*nbRows;
	document.getElementById("Radar-Info").style.textAlign = "center";
	
	d3.select('#downloadRadar').text(function () {return 'Download';});
	
	function downloadCanvas(link, filename) {
		var division = document.getElementById("theRadar");
		var svg = division.children[0];
		var img = document.getElementById("fromcanvasRadar");

		if(saveToPng){
			svg.toDataURL("image/png", {
				callback: function(data) {
					link.href = data;
					link.download = filename;
				}
			})
		}else{
			svg.toDataURL("image/svg+xml", {
				callback: function(data) {
					link.href = data;
					link.download = filename;
				}
			})
		}
	}
	
	document.getElementById('downloadRadar').addEventListener('click', function() {
		if(saveToPng){
			downloadCanvas(this, 'Radar.png');
		}else{
			downloadCanvas(this, 'Radar.svg');
		}
	}, false);
	

	if(topology.localeCompare('rectangular')==0){
		d3.select('#Radar-Info').text(function () {return 'Square Grid : Radar';});
		radarSquareSizeGrid();
	}else if(topology.localeCompare('hexagonal')==0){
		d3.select('#Radar-Info').text(function () {return 'Hexagonal Grid : Radar';});
		radarHexagonalGrid();
	}
	
	function radarSquareSizeGrid(){
		
		var svg = d3.select('#theRadar').append('svg')
			.attr("style"," display:block; margin:auto; margin-top:30px;")
			.attr({
			width: w,
			height: h
		});

		_.times(nbRows, function(n) {
			var rows = svg.selectAll('rect' + ' .row-' + (n + 1))
				.data(d3.range(nbColumns))
				.enter().append('rect')
				.attr({
					class: function(d, i) {
						return 'square row-' + (n + 1) + ' ' + 'col-' + (i + 1);
					},
					id: function(d, i) {
						return 's-' + (n + 1) + (i + 1);
					},
					width: cellSize,
					height: cellSize,
					x: function(d, i) {
						return i * cellSize;
					},
					y: n * cellSize,
					fill: function(d, i) {
						var indice = superclass[(n*nbColumns)+i];
						return superclassColor[indice-1];
					},
					stroke: '#FDBB30'
				});

			var array = d3.range(nbColumns);
			var width = cellSize*50/100;
			var height = cellSize*50/100;
			var radius = Math.min(width, height) / 2;

			svg.selectAll('rect' + ' .row-' + (n + 1))
				.data(d3.range(nbColumns))
				.append('g')


			for (p = 0; p < array.length; p++) {
				var arc = d3.svg.arc().outerRadius(function function_name(d,i) { return d.data.normalizedValue*0.4;});
						
				var innerArrayNormalizedValues = [];
				innerArrayNormalizedValues= radarNormalizedValues[(n*nbColumns)+p];
					
				var innerArrayRealValues = [];
				innerArrayRealValues= radarRealValues[(n*nbColumns)+p];
					
				var arrayValues = [];
				for(var j=0; j<parts; j++){
					arrayValues[j] = [];
					arrayValues[j].normalizedValue = innerArrayNormalizedValues[j]*cellSize;
					arrayValues[j].realValue = innerArrayRealValues[j];
				}

				var pie = d3.layout.pie()
					.value(function(d) {  return 100/parts; })
					.sort(null);
				
				var pieParts = svg.selectAll('rect' + ' .row-' + (n + 1))
					.data(pie(arrayValues))
					.enter()
					.append('path')
					.attr('d', arc)
					.attr('transform', 'translate(' + (array[p] * cellSize + cellSize/2) +
						',' + (n * cellSize + cellSize/2) + ')')
					.attr('fill', function(d, i) {
						return labelColor[i];
					});

				rows.on('mouseover', function (d, i) {
					var el = d3.select(this)
						.transition()
						.duration(10)		  
						.style("fill-opacity", 0.8);
								
					d3.select('#Radar-Info').text(function () {
						var ch = 'row: ' + (n + 1) + ' | ' + 'column: ' + (i + 1) + ' | ' + 'size: ' + radarRealSize[(n*nbColumns)+i] + ' | ';
						return ch;
					}); 
				});

				rows.on('mouseout', function (d, i) {
					var el = d3.select(this)
						.transition()
						.duration(1000)
						.style("fill-opacity", 1);
				});
						
				pieParts.on('mouseenter', function (d, i) {
					d3.select('#Radar-Info').text(function () { 
						var innerArrayRealValues = [];
						var ch=label[i]+": " + d.data.realValue;
						return ch;	
					}); 	
								
					d3.select(this)
						.attr("stroke","white")
						.transition()
						.duration(50)
						.attr("stroke-width",2);
				});

				pieParts.on('mouseleave', function (d, i) {
					d3.select(this).transition()
						.duration(50)
						.attr("stroke","none");
				});
			
			}

		});
	}
	
	function radarHexagonalGrid(){
		var margin = {
			top: 30,
			right: 20,
			bottom: 20,
			left: 50
		};

		var width = 850;
		var height = 350;
		var widtht = 850;
		var heightt = 350;

		var hexRadius=cellSize/2;	
		var hexInRadius;	
			

		//Set the new height and width of the SVG based on the max possible
		width = nbColumns*hexRadius*Math.sqrt(3);
		height = nbRows*1.5*hexRadius+0.5*hexRadius;

		//Set the hexagon radius
		var hexbin = d3.hexbin().radius(hexRadius);
			   
		//Calculate the center positions of each hexagon	
		var points = [];
		for (var i = 0; i < nbRows; i++) {
			for (var j = 0; j < nbColumns; j++) {
				points.push([hexRadius * j * 1.75, hexRadius * i * 1.5]);
			}
		}

		var svg = d3.select("#theRadar").append("svg")
			.attr("width", width+hexRadius+5)
			.attr("height", height)
			.attr("style"," display:block; margin:auto; margin-top:30px;")
			.append("g")
			.attr("transform", "translate(" + hexRadius + "," + hexRadius+ ")");

		var hexa = svg.selectAll(".hexagon")
			.data(hexbin(points))
			.enter().append("path")
			.attr("class", "hexagon")
			.attr("d", function (d) {
				return "M" + d.x + "," + d.y + hexbin.hexagon();
			})
			.attr("stroke", function (d,i) {
				return "#fff";
			})
			.attr("stroke-width", "1px")
			.style("fill", function (d,i) {
				var indice = superclass[i];
				return superclassColor[indice-1];
			});
		
		var array = d3.range(nbColumns);
        var width = hexRadius;
        var height = hexRadius;
        var radius = Math.min(width, height)/ 2;

        svg.selectAll(".hexagon").data(d3.range(nbColumns)).append('g')

		var coordinatesArray = hexbin(points);
		
		for (var n = 0; n < nbRows*nbColumns; n++) {
			
			var arc = d3.svg.arc().outerRadius(function function_name(d,i) { return d.data.normalizedValue*0.4;});
			
			var innerArrayNormalizedValues = [];
			innerArrayNormalizedValues= radarNormalizedValues[n];	
			
			var innerArrayRealValues = [];
			innerArrayRealValues= radarRealValues[n];
			var arrayValues = [];
			
			for(var j=0; j<parts; j++){
				arrayValues[j] = [];
				arrayValues[j].normalizedValue = innerArrayNormalizedValues[j]*cellSize;
				arrayValues[j].realValue = innerArrayRealValues[j];
			}

			var pie = d3.layout.pie()
				.value(function(d) { return 100/parts; })
				.sort(null);

			var pieParts = svg.append("g")
				.selectAll(".hexagon")
				.data(pie(arrayValues))
				.enter()
				.append('path')
				.attr("class", "pie")
				.attr('d', arc)
				.attr('transform', 'translate(' + (coordinatesArray[n].x) +',' + coordinatesArray[n].y + ')')
				.attr('fill', function(d, i) {
					return labelColor[i];
				})	
				
			hexa.on('mouseover', function (d, i) {
				var el = d3.select(this)
					.transition()
					.duration(10)		  
					.style("fill-opacity", 0.8);
								
				d3.select('#Radar-Info').text(function () {
					var ch = 'row: ' + parseInt((i/nbRows)+1,10) + ' | ' + 'column: ' + parseInt((i%nbRows)+1,10) + ' | ' + 'size: ' + radarRealSize[i];
					return ch;
				}); 
			});

			hexa.on('mouseout', function (d, i) {
				var el = d3.select(this)
					.transition()
					.duration(1000)
					.style("fill-opacity", 1);
				});
						
			pieParts.on('mouseenter', function (d, i) {
				d3.select('#Radar-Info').text(function () { 
					var innerArrayRealValues = [];
					var ch=label[i]+": " + d.data.realValue;
					return ch;	
				}); 	
								
				d3.select(this)
					.attr("stroke","white")
					.transition()
					.duration(50)
					.attr("stroke-width",2);
			});

			pieParts.on('mouseleave', function (d, i) {
				d3.select(this).transition()
					.duration(50)
					.attr("stroke","none");
			});
		}		
	}
	
	
  }
});
Shiny.outputBindings.register(histOutputBinding, 'just.testing');			
</script>	