<style>
  .box {
	  font: 10px sans-serif;
	}

	.box line,
	.box rect,
	.box circle {
	  stroke: #000;
	}
</style>


<header>
  <h4 id="Boxplot-Info"></h4>
</header>

<script>

var histOutputBinding = new Shiny.OutputBinding();

  $.extend(histOutputBinding, {
    find: function(scope) {
      return $(scope).find('.shiny-Boxplot');
    },
    renderValue: function(el, data) {
    //remove the old graph
	document.getElementById("theBoxplot").innerHTML = "";
	if(data == null ) {return;}
	
	var nbRows=data.gridInfo.nbLines;
	var nbColumns=data.gridInfo.nbColumns;
	var topology = data.gridInfo.topology;
	var superclass = data.superclass;
	var superclassColor = data.superclassColor;
	var nbBox = data.nbBox;
	var label = data.label;
	var labelColor = data.labelColor;
    var cellSize = data.sizeInfo;
	var boxPlotNormalizedValues = data.boxPlotNormalizedValues;
	var boxPlotRealValues = data.boxPlotRealValues;
	var boxNormalizedExtremesValues= data.boxNormalizedExtremesValues;
	var boxRealExtremesValues= data.boxRealExtremesValues;
    var w = cellSize*nbColumns;
    var h = cellSize*nbRows;
	document.getElementById("Boxplot-Info").style.textAlign = "center";
	
	if(topology.localeCompare('rectangular')==0){
		d3.select('#Boxplot-Info').text(function () {return 'Square Grid : BoxPlot';});
		boxPlotSquareGrid();
	}else if(topology.localeCompare('hexagonal')==0){
		d3.select('#Boxplot-Info').text(function () {return 'Hexagonal Grid : BoxPlot';});
		boxPlotHexagonalGrid();
	}
	
	function boxPlotSquareGrid(){
		
		var svg = d3.select('#theBoxplot').append('svg')
			.attr("style"," display:block; margin:auto; margin-top:30px; background-color:blue")
			.attr({
				width: w,
				height: h
			});
	
		_.times(nbRows, function(n) {
			var rows = svg.selectAll('rect' + ' .row-' + (n + 1))
				.data(d3.range(nbColumns))
				.enter().append('rect')
				.attr({
					class: function(d, i) {
						return 'square row-' + (n + 1) + ' ' + 'col-' + (i + 1);
					},
					id: function(d, i) {
						return 's-' + (n + 1) + (i + 1);
					},
					width: cellSize,
					height: cellSize,
					x: function(d, i) {
						return i * cellSize;
					},
					y: n * cellSize,
					fill: function(d, i) {
						var indice = superclass[(n*nbColumns)+i];
						return superclassColor[indice-1];
					},
					stroke: '#FDBB30'
				});

			svg.selectAll('rect' + ' .row-' + (n + 1))
				.data(d3.range(nbColumns))
				.append('g')

			var width = (cellSize*80/100)/(nbBox)-(cellSize*10/100),
				height = (cellSize*70/100);
			
			if(nbBox==1){width = (cellSize*20/100);
						 height = (cellSize*40/100);}
			
			var min = Infinity,
				max = -Infinity;

			var chart = d3.box()
				//.whiskers(iqr(1.5))
				.width(width)
				.height(height);
		
			// Returns a function to compute the interquartile range.
			function iqr(k) {
				return function(d, i) {
					var q1 = d.quartiles[0],
					q3 = d.quartiles[2],
					iqr = (q3 - q1) * k,
					i = -1,
					j = d.length;
					while (d[++i] < q1 - iqr);
					while (d[--j] > q3 + iqr);
					return [i, j];
				};
			}
			
			var array = d3.range(nbColumns);
			
			for (p = 0; p < array.length; p++) {
				var innerArrayNormalizedValues = boxPlotNormalizedValues[(n*nbColumns)+p];
				var innerArrayRealValues = boxPlotRealValues[(n*nbColumns)+p];
				var innerArrayExtremesNormalizedValues = boxNormalizedExtremesValues[(n*nbColumns)+p];
				var innerArrayExtremesRealValues = boxRealExtremesValues[(n*nbColumns)+p];

				var arrayValues = [];
				var data = [];
				
				for(var j=0; j<nbBox; j++){
					arrayValues[j] = [];
					arrayValues[j].normalizedValues = innerArrayNormalizedValues[j];
					arrayValues[j].realValues = innerArrayRealValues[j];
					
					var speed = arrayValues[j].normalizedValues;					
					for(l=0; l<5; l++){
						var e = Math.floor(j),
						r = Math.floor(l),
						s = Math.floor(speed[l]*cellSize),
						d = data[e];
						
						if (!d) { d = data[e] = [s];}
						else { d.push(s);}
						if (s > max) max = s;
						if (s < min) min = s;
					}
					data[j].realValues = arrayValues[j].realValues;
				}
				
				chart.domain([min, max]);
				
				var boxs = svg.selectAll('rect' + ' .row-' + (n + 1))
					.data(data)
					.enter().append("g")
					.attr("class", "box")
					.attr("width",  width)
					.attr("height", height)
					.append("g")
					.attr('transform', function(d, i) { 
						if(nbBox==1){
							return 'translate(' + (cellSize*40/100+i*((cellSize*40/100)/(nbBox)) + p*cellSize) + ',' + (n * cellSize + cellSize*30/100) + ')';
						}else{
							return 'translate(' + ((cellSize*15/100+i*((cellSize*80/100)/(nbBox))) + p*cellSize) + ',' + (n * cellSize + cellSize*15/100) + ')';
						}
					})
					.attr('fill', function(d, i) { 
							return labelColor[i];
					})
					.call(chart);

				for(var j=0; j<nbBox; j++){
					
					var arrayExtremesValues = [];
					var arrNormalizedValues = innerArrayExtremesNormalizedValues[j];
					var arrRealValues = innerArrayExtremesRealValues[j];
					
					for(var l=0; l<arrNormalizedValues.length; l++){
						arrayExtremesValues[l] = [];
						arrayExtremesValues[l].normalizedValues = arrNormalizedValues[l];
						arrayExtremesValues[l].realValues = arrRealValues[l];
						arrayExtremesValues[l].label = label[j];
					}
					
					var focus = boxs.select("g.box")
						.data(arrayExtremesValues)
						.enter()
						.append("circle")
						.attr("class", "y")
						.attr('transform', function(d, i) { 
							if(nbBox==1){
								return 'translate(' + (cellSize*40/100+j*(cellSize*40/100) + width/2 + p*cellSize) + ',' + (cellSize*0.9 - d.normalizedValues*cellSize*0.9 + n * cellSize) + ')';
							}else{
								return 'translate(' + ((cellSize*15/100+j*((cellSize*80/100)/(nbBox)) + width/2) + p*cellSize) + ',' + (cellSize*0.90 - d.normalizedValues*cellSize*0.85 + n * cellSize) + ')';
							}
						})
						.attr("r", cellSize*4/100)
						.attr('fill', function(d, i) { 
								return labelColor[j];
						})
						.style("stroke", "#112E45")
						.attr("stroke-width",1);
					
					focus.on('mouseenter', function (d, i) {
						d3.select('#Boxplot-Info').text(function () { 
							var ch=d.label+": " + d.realValues;
							return ch;	
						});
									
						d3.select(this)
							.transition()
							.duration(50)
							.attr("stroke-width",2)
					});

					focus.on('mouseleave', function (d, i) {
						d3.select(this).transition()
							.duration(50)
							.attr("stroke-width",1);
					});
				}
				
				
				rows.on('mouseover', function (d, i) {	
					d3.select('#Boxplot-Info').text(function () {
						var ch = 'row: ' + (n + 1) + ' | ' + 'column: ' + (i + 1) + ' | ' + 'superclasse : ' + superclass[(n*nbColumns)+i];
						return ch;
						});
						
					var el = d3.select(this)
						.transition()
						.duration(10)		  
						.style("fill-opacity", 0.8);		 
				});

				rows.on('mouseout', function (d, i) {
					var el = d3.select(this)
						.transition()
						.duration(1000)
						.style("fill-opacity", 1);
				});				
				
				boxs.on('mouseenter', function (d, i) {
					d3.select('#Boxplot-Info').text(function () { 
						var ch=label[i]+": " + d.realValues;
						return ch;	
					});
								
					d3.select(this)
						.transition()
						.duration(50)
						.attr("stroke-width",2)
				});

				boxs.on('mouseleave', function (d, i) {
					d3.select(this).transition()
						.duration(50)
						.attr("stroke-width",1);
				});
			}
		});
	}
	
	function boxPlotHexagonalGrid(){
		var margin = {
			top: 30,
			right: 20,
			bottom: 20,
			left: 50
		};

		var width = 850;
		var height = 350;
		var widtht = 850;
		var heightt = 350;

		var hexRadius=cellSize/2;	
		var hexInRadius;	
			

		//Set the new height and width of the SVG based on the max possible
		width = nbColumns*hexRadius*Math.sqrt(3);
		height = nbRows*1.5*hexRadius+0.5*hexRadius;

		widtht = nbColumns*hexInRadius*Math.sqrt(3);
		heightt = nbRows*1.5*hexInRadius+0.5*hexInRadius;


		//Set the hexagon radius
		var hexbin = d3.hexbin().radius(hexRadius);
			   
		var hexbint = d3.hexbin().radius(hexInRadius);
			   
		//Calculate the center positions of each hexagon	
		var points = [];
		for (var i = 0; i < nbRows; i++) {
			for (var j = 0; j < nbColumns; j++) {
				points.push([hexRadius * j * 1.75, hexRadius * i * 1.5]);
			}
		}

		//Calculate the center positions of each element in the hexagon
		var pointst = [];
		for (var i = 0; i < nbRows; i++) {
			for (var j = 0; j < nbColumns; j++) {
				pointst.push([(hexInRadius *j *1.75), hexInRadius *i*1.5]);
			}
		}

		var svg = d3.select("#theBoxplot").append("svg")
			.attr("width", width+hexRadius+5)
			.attr("height", height)
			.attr("style"," display:block; margin:auto; margin-top:30px;")
			.append("g")
			.attr("transform", "translate(" + hexRadius + "," + hexRadius+ ")");

		var hexa = svg.selectAll(".hexagon")
			.data(hexbin(points))
			.enter().append("path")
			.attr("class", "hexagon")
			.attr("d", function (d) {
				return "M" + d.x + "," + d.y + hexbin.hexagon();
			})
			.attr("stroke", function (d,i) {
				return "#fff";
			})
			.attr("stroke-width", "1px")
			.style("fill", function (d,i) {
				var indice = superclass[i];
				return superclassColor[indice-1];
			});

		var width = (cellSize*80/100)/(nbBox)-(cellSize*10/100),
			height = (cellSize*50/100);

		if(nbBox==1){width = (cellSize*20/100);
					 height = (cellSize*30/100);}
		
		var min = Infinity,
			max = -Infinity;

		var chart = d3.box()
			//.whiskers(iqr(1.5))
			.width(width)
			.height(height);
		
		// Returns a function to compute the interquartile range.
		function iqr(k) {
			return function(d, i) {
				var q1 = d.quartiles[0],
				q3 = d.quartiles[2],
				iqr = (q3 - q1) * k,
				i = -1,
				j = d.length;
				while (d[++i] < q1 - iqr);
				while (d[--j] > q3 + iqr);
				return [i, j];
			};
		}
			
		var array = d3.range(nbColumns);
		var coordinatesArray = hexbin(points);
	
		for (var p = 0; p < nbRows*nbColumns; p++) {	
		
			var innerArrayNormalizedValues = boxPlotNormalizedValues[p];
			var innerArrayRealValues = boxPlotRealValues[p];
			var innerArrayExtremesNormalizedValues = boxNormalizedExtremesValues[p];
			var innerArrayExtremesRealValues = boxRealExtremesValues[p];
				
			var arrayValues = [];
			var data = [];
				
			for(var j=0; j<nbBox; j++){
				arrayValues[j] = [];
				arrayValues[j].normalizedValues = innerArrayNormalizedValues[j];
				arrayValues[j].realValues = innerArrayRealValues[j];
					
				var speed = arrayValues[j].normalizedValues;
					
				for(l=0; l<5; l++){
					var e = Math.floor(j),
					r = Math.floor(l),
					s = Math.floor(speed[l]*cellSize),
					d = data[e];
					
					if (!d) { d = data[e] = [s];}
					else { d.push(s);}
					if (s > max) max = s;
					if (s < min) min = s;
				}

				data[j].realValues = arrayValues[j].realValues;
			}

			chart.domain([min, max]);
				
			var boxs = svg.selectAll("hexagon")
				.data(data)
				.enter().append("g")
				.attr("class", "box")
				.attr("width",  width)
				.attr("height", height)
				.append("g")
				.attr('transform', function(d, i) { 
					if(nbBox==1){
						return 'translate(' + (cellSize*40/100+i*(cellSize*30/100) + coordinatesArray[p].x -cellSize/2) + ',' + (coordinatesArray[p].y - cellSize*15/100)+ ')';
					}else{
						return 'translate(' + ((cellSize*15/100+i*((cellSize*80/100)/(nbBox))) + coordinatesArray[p].x -cellSize/2) + ',' + (coordinatesArray[p].y - cellSize*25/100)+ ')';
					}
				})
				.attr('fill', function(d, i) { 
						return labelColor[i];
				})
				.call(chart);	
			
			for(var j=0; j<nbBox; j++){
				var arrayExtremesValues = [];
				var arrNormalizedValues = innerArrayExtremesNormalizedValues[j];
				var arrRealValues = innerArrayExtremesRealValues[j];
					
				for(var l=0; l<arrNormalizedValues.length; l++){
					arrayExtremesValues[l] = [];
					arrayExtremesValues[l].normalizedValues = arrNormalizedValues[l];
					arrayExtremesValues[l].realValues = arrRealValues[l]
					arrayExtremesValues[l].label = label[j];
				}
					
				var focus = boxs.select("g.box")
					.data(arrayExtremesValues)
					.enter()
					.append("circle")
					.attr("class", "y")
					.attr('transform', function(d, i) { 
						if(nbBox==1){
							return 'translate(' + (cellSize*40/100+j*(cellSize*40/100) + width/2 + coordinatesArray[p].x -cellSize/2) + ',' + (coordinatesArray[p].y + cellSize*25/100 - d.normalizedValues*cellSize*60/100) + ')';
						}else{
							return 'translate(' + ((cellSize*15/100+j*((cellSize*80/100)/(nbBox)) + width/2) + coordinatesArray[p].x -cellSize/2) + ',' + (coordinatesArray[p].y + cellSize*25/100 - d.normalizedValues*cellSize*52/100) + ')';
						}
					})
					.attr("r", cellSize*3/100)
					.attr('fill', function(d, i) { 
							return labelColor[j];
					})
					.style("stroke", "#112E45")
					.attr("stroke-width",1);
					
				focus.on('mouseenter', function (d, i) {
					d3.select('#Boxplot-Info').text(function () { 
						var ch=d.label+": " + d.realValues;
						return ch;	
					});
									
					d3.select(this)
						.transition()
						.duration(50)
						.attr("stroke-width",2)
				});

				focus.on('mouseleave', function (d, i) {
					d3.select(this).transition()
						.duration(50)
						.attr("stroke-width",1);
				});
			}
				
			hexa.on('mouseover', function (d, i) {	
				d3.select('#Boxplot-Info').text(function () {
					var indice = (parseInt((i/nbRows),10)*nbColumns)+ parseInt((i%nbRows),10);
					var ch = 'row: ' + parseInt((i/nbRows)+1,10) + ' | ' + 'column: ' + parseInt((i%nbRows)+1,10) + ' | ' + 'superclasse : ' + superclass[indice];
					return ch;
					});
					
				var el = d3.select(this)
					.transition()
					.duration(10)		  
					.style("fill-opacity", 0.8);		 
			});

			hexa.on('mouseout', function (d, i) {
				var el = d3.select(this)
					.transition()
					.duration(1000)
					.style("fill-opacity", 1);
			});				
				
			boxs.on('mouseenter', function (d, i) {
				d3.select('#Boxplot-Info').text(function () { 
					var ch=label[i]+": " + d.realValues;
					return ch;	
				});
				
				d3.select(this)
					.transition()
					.duration(50)
					.attr("stroke-width",2);
			});

			boxs.on('mouseleave', function (d, i) {
				d3.select(this).transition()
					.duration(50)
					.attr("stroke-width",1);
			});			
		}			
	}
  }
});
Shiny.outputBindings.register(histOutputBinding, 'just.testing');			
</script>	